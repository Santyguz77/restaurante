<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#ff6b35">
	<link rel="manifest" href="/manifest.json">
	<link rel="icon" type="image/png" href="/image.png">
	<title>Test PWA - Restaurante</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			background: #1a0f0a;
			color: #f5ebe0;
			padding: 20px;
			max-width: 600px;
			margin: 0 auto;
		}
		h1 { color: #ff6b35; }
		.test-item {
			background: #2a1810;
			padding: 15px;
			margin: 10px 0;
			border-radius: 8px;
			border-left: 4px solid #666;
		}
		.test-item.success { border-left-color: #4caf50; }
		.test-item.error { border-left-color: #f44336; }
		.test-item.warning { border-left-color: #ff9800; }
		button {
			background: #ff6b35;
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 16px;
			margin: 10px 5px;
		}
		button:hover { background: #ff8555; }
		pre {
			background: #0a0503;
			padding: 10px;
			border-radius: 4px;
			overflow-x: auto;
			font-size: 12px;
		}
		.icon-preview {
			width: 100px;
			height: 100px;
			border-radius: 12px;
			margin: 10px;
		}
	</style>
</head>
<body>
	<h1>üîç Diagn√≥stico PWA</h1>
	<p>Verifica si tu app cumple los requisitos para instalaci√≥n</p>
	
	<button onclick="runTests()">Ejecutar Tests</button>
	<button onclick="installApp()" id="installBtn" style="display:none;">üì± Instalar App</button>
	
	<div id="results"></div>

	<script>
		let deferredPrompt;
		
		// Capturar evento de instalaci√≥n
		window.addEventListener('beforeinstallprompt', (e) => {
			e.preventDefault();
			deferredPrompt = e;
			document.getElementById('installBtn').style.display = 'inline-block';
			addResult('‚úÖ App es instalable', 'El navegador detect√≥ que la PWA puede instalarse', 'success');
		});
		
		window.addEventListener('appinstalled', () => {
			addResult('‚úÖ App instalada', 'La PWA se instal√≥ correctamente', 'success');
			deferredPrompt = null;
		});
		
		function addResult(title, content, type = 'test-item') {
			const div = document.createElement('div');
			div.className = `test-item ${type}`;
			div.innerHTML = `<strong>${title}</strong><div>${content}</div>`;
			document.getElementById('results').appendChild(div);
		}
		
		async function installApp() {
			if (!deferredPrompt) {
				alert('La app ya est√° instalada o no est√° disponible para instalar');
				return;
			}
			
			deferredPrompt.prompt();
			const { outcome } = await deferredPrompt.userChoice;
			
			if (outcome === 'accepted') {
				addResult('‚úÖ Instalaci√≥n aceptada', 'El usuario acept√≥ instalar la app', 'success');
			} else {
				addResult('‚ùå Instalaci√≥n cancelada', 'El usuario rechaz√≥ la instalaci√≥n', 'warning');
			}
			
			deferredPrompt = null;
			document.getElementById('installBtn').style.display = 'none';
		}
		
		async function runTests() {
			document.getElementById('results').innerHTML = '';
			
			// Test 1: HTTPS
			const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
			addResult(
				isHTTPS ? '‚úÖ HTTPS' : '‚ùå HTTPS requerido',
				isHTTPS ? 'El sitio usa conexi√≥n segura' : 'PWA requiere HTTPS (excepto en localhost)',
				isHTTPS ? 'success' : 'error'
			);
			
			// Test 2: Manifest
			try {
				const manifestResponse = await fetch('/manifest.json');
				if (manifestResponse.ok) {
					const manifest = await manifestResponse.json();
					addResult('‚úÖ Manifest encontrado', `<pre>${JSON.stringify(manifest, null, 2)}</pre>`, 'success');
					
					// Verificar campos requeridos
					const required = ['name', 'short_name', 'start_url', 'display', 'icons'];
					const missing = required.filter(field => !manifest[field]);
					
					if (missing.length > 0) {
						addResult('‚ö†Ô∏è Campos faltantes', `Faltan: ${missing.join(', ')}`, 'warning');
					}
					
					// Verificar iconos
					if (manifest.icons && manifest.icons.length > 0) {
						const hasRequired = manifest.icons.some(icon => 
							icon.sizes.includes('192x192') || icon.sizes.includes('512x512')
						);
						addResult(
							hasRequired ? '‚úÖ Iconos OK' : '‚ö†Ô∏è Iconos insuficientes',
							hasRequired ? 'Tiene iconos de 192x192 o 512x512' : 'Se recomienda iconos de 192x192 y 512x512',
							hasRequired ? 'success' : 'warning'
						);
						
						// Preview del icono
						const iconDiv = document.createElement('div');
						iconDiv.className = 'test-item';
						iconDiv.innerHTML = `<strong>Vista previa del icono:</strong><br><img src="${manifest.icons[0].src}" class="icon-preview" onerror="this.parentElement.innerHTML='‚ùå No se pudo cargar la imagen'">`;
						document.getElementById('results').appendChild(iconDiv);
					}
				} else {
					addResult('‚ùå Manifest no encontrado', 'No se pudo cargar /manifest.json', 'error');
				}
			} catch (error) {
				addResult('‚ùå Error en Manifest', error.message, 'error');
			}
			
			// Test 3: Service Worker
			if ('serviceWorker' in navigator) {
				const registrations = await navigator.serviceWorker.getRegistrations();
				if (registrations.length > 0) {
					addResult('‚úÖ Service Worker registrado', `${registrations.length} registraciones activas`, 'success');
					registrations.forEach((reg, i) => {
						addResult(`SW #${i+1}`, `Scope: ${reg.scope}<br>Estado: ${reg.active ? 'Activo' : 'Inactivo'}`, 'success');
					});
				} else {
					addResult('‚ùå Service Worker no registrado', 'No hay service workers activos', 'error');
				}
			} else {
				addResult('‚ùå Service Workers no soportados', 'Este navegador no soporta Service Workers', 'error');
			}
			
			// Test 4: Instalabilidad
			if (deferredPrompt) {
				addResult('‚úÖ Evento beforeinstallprompt capturado', 'La app puede instalarse ahora', 'success');
			} else {
				addResult('‚ö†Ô∏è Sin evento de instalaci√≥n', 'Puede que ya est√© instalada o falten requisitos', 'warning');
			}
			
			// Test 5: Verificar si ya est√° instalada
			if (window.matchMedia('(display-mode: standalone)').matches) {
				addResult('‚úÖ App ya instalada', 'Est√°s ejecutando la PWA instalada', 'success');
			}
		}
		
		// Auto-ejecutar al cargar
		window.addEventListener('load', () => {
			setTimeout(runTests, 500);
		});
	</script>
</body>
</html>
