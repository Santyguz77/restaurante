<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#ff6b35">
	<link rel="manifest" href="/manifest.json">
	<link rel="icon" type="image/png" href="/image.png">
	<link rel="apple-touch-icon" href="/image.png">
	<link rel="stylesheet" href="styles.css">
	<script src="ttps://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<title>Admin - Sistema Restaurante</title>
	<style>
		/* Men√∫ Hamburguesa */
		.hamburger {
			display: none;
			position: fixed;
			top: 15px;
			left: 15px;
			z-index: 1001;
			background: var(--accent);
			border: none;
			color: white;
			width: 50px;
			height: 50px;
			border-radius: 50%;
			font-size: 24px;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
			transition: transform 0.3s;
		}
		.hamburger:active {
			transform: scale(0.95);
		}
		.mobile-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.7);
			z-index: 999;
		}
		.mobile-overlay.active {
			display: block;
		}
		.sidebar.mobile-open {
			transform: translateX(0) !important;
		}
		
		@media (max-width: 768px) {
			.hamburger {
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.sidebar {
				position: fixed;
				left: 0;
				top: 0;
				height: 100vh;
				transform: translateX(-100%);
				transition: transform 0.3s ease;
				z-index: 1000;
				width: 260px;
			}
			.main {
				margin-left: 0;
				padding: 80px 15px 20px 15px;
			}
		}
		
		.dashboard-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		.stat-card {
			background: linear-gradient(135deg, var(--panel), var(--card));
			padding: 25px;
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
			border: 1px solid rgba(255, 107, 53, 0.1);
		}
		.stat-card h3 {
			font-size: 14px;
			color: var(--muted);
			text-transform: uppercase;
			margin-bottom: 10px;
		}
		.stat-card .value {
			font-size: 36px;
			font-weight: 700;
			color: var(--accent);
		}
		.section {
			display: none;
		}
		.section.active {
			display: block;
		}
		.order-card {
			background: rgba(0, 0, 0, 0.3);
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 15px;
			border-left: 4px solid var(--accent);
		}
		.order-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.order-items-list {
			margin: 10px 0;
			padding: 10px;
			background: rgba(0, 0, 0, 0.2);
			border-radius: 6px;
		}
		.order-item-line {
			display: flex;
			justify-content: space-between;
			padding: 5px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}
		.close-cash-summary {
			background: linear-gradient(135deg, var(--success), #388e3c);
			color: #fff;
			padding: 30px;
			border-radius: 12px;
			margin-top: 20px;
		}
		.close-cash-summary h2 {
			margin-bottom: 20px;
		}
		.close-cash-line {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.2);
			font-size: 18px;
		}
		.close-cash-total {
			font-size: 32px;
			font-weight: 700;
			margin-top: 20px;
			text-align: right;
		}
		
		@keyframes pulse {
			0%, 100% { opacity: 1; transform: scale(1); }
			50% { opacity: 0.5; transform: scale(1.2); }
		}
		
		@keyframes slideIn {
			from { transform: translateX(400px); opacity: 0; }
			to { transform: translateX(0); opacity: 1; }
		}
		
		@keyframes slideOut {
			from { transform: translateX(0); opacity: 1; }
			to { transform: translateX(400px); opacity: 0; }
		}
	</style>
</head>
<body>
	<script>
		// Verificar sesi√≥n de admin
		const session = localStorage.getItem('userSession');
		if (!session) {
			window.location.href = '/login.html';
		} else {
			const userData = JSON.parse(session);
			if (userData.type !== 'admin') {
				alert('‚ö†Ô∏è Acceso denegado. Esta p√°gina es solo para administradores.');
				window.location.href = '/login.html';
			}
		}
	</script>
	<!-- Bot√≥n Hamburguesa (solo m√≥vil) -->
	<button class="hamburger" onclick="toggleMobileMenu()" aria-label="Men√∫">
		‚ò∞
	</button>
	
	<!-- Overlay para cerrar men√∫ en m√≥vil -->
	<div class="mobile-overlay" onclick="closeMobileMenu()"></div>
	
	<div class="app">
		<!-- Sidebar -->
		<div class="sidebar" id="sidebar">
			<div class="brand">
				<img src="image.png" alt="Logo" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px;">
				<div>Restaurante</div>
				<span>Panel de Control</span>
			</div>
			<ul class="menu">
				<li class="active" onclick="showSection('dashboard'); closeMobileMenu();">
					<span class="menu-icon">üìä</span> Dashboard
				</li>
				<li onclick="showSection('tables'); closeMobileMenu();">
					<span class="menu-icon">ü™ë</span> Mesas
				</li>
				<li onclick="showSection('orders'); closeMobileMenu();">
					<span class="menu-icon">üìù</span> Pedidos
				</li>
				<li onclick="showSection('menu-config'); closeMobileMenu();">
					<span class="menu-icon">üçî</span> Men√∫
				</li>
				<li onclick="showSection('transactions'); closeMobileMenu();">
					<span class="menu-icon">üí∞</span> Finanzas
				</li>
				<li onclick="showSection('close-cash'); closeMobileMenu();">
					<span class="menu-icon">üîí</span> Cierre de Caja
				</li>
				<li onclick="logout()" style="margin-top: 20px; border-top: 1px solid rgba(255,107,53,0.2); padding-top: 15px;">
					<span class="menu-icon">üö™</span> Cerrar Sesi√≥n
				</li>
			</ul>
		</div>

		<!-- Main Content -->
		<div class="main">
			<!-- Dashboard -->
			<div id="dashboard" class="section active">
				<div class="header">
					<h1>Dashboard</h1>
					<div style="display: flex; align-items: center; gap: 15px;">
						<button class="btn" onclick="refreshData()">üîÑ Actualizar</button>
						<span style="color: #4caf50; font-size: 14px; display: flex; align-items: center; gap: 5px;">
							<span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite;"></span>
							Auto-actualizaci√≥n activa
						</span>
					</div>
				</div>

				<div class="dashboard-grid">
					<div class="stat-card">
						<h3>Mesas Ocupadas</h3>
						<div class="value" id="stat-tables">0</div>
					</div>
					<div class="stat-card">
						<h3>Pedidos Activos</h3>
						<div class="value" id="stat-orders">0</div>
					</div>
					<div class="stat-card">
						<h3>Ventas Hoy</h3>
						<div class="value" id="stat-sales">$0</div>
					</div>
					<div class="stat-card">
						<h3>Total Mes</h3>
						<div class="value" id="stat-month">$0</div>
					</div>
				</div>

				<div class="card">
					<h3>Mesas en Tiempo Real</h3>
					<div class="tables-grid" id="dashboard-tables"></div>
				</div>
			</div>

			<!-- Mesas -->
			<div id="tables" class="section">
				<div class="header">
					<h1>Gesti√≥n de Mesas</h1>
					<button class="btn" onclick="openTableModal()">‚ûï Agregar Mesa</button>
				</div>
				<div class="card">
					<div class="tables-grid" id="tables-list"></div>
				</div>
			</div>

			<!-- Pedidos -->
			<div id="orders" class="section">
				<div class="header">
					<h1>Pedidos Activos</h1>
					<div class="controls">
						<button class="btn btn-success" onclick="refreshData()">üîÑ Actualizar</button>
					</div>
				</div>
				<div class="card" id="orders-list"></div>
			</div>

			<!-- Configuraci√≥n de Men√∫ -->
			<div id="menu-config" class="section">
				<div class="header">
					<h1>Configuraci√≥n del Men√∫</h1>
					<button class="btn" onclick="openMenuItemModal()">‚ûï Nuevo Producto</button>
				</div>
				<div class="card">
					<div class="table-scroll">
						<table id="menu-table">
							<thead>
								<tr>
									<th>Nombre</th>
									<th>Descripci√≥n</th>
									<th>Categor√≠a</th>
									<th>Precio</th>
									<th>Disponible</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Finanzas -->
			<div id="transactions" class="section">
				<div class="header">
					<h1>Historial de Transacciones</h1>
				</div>
				<div class="card">
					<div class="table-scroll">
						<table id="transactions-table">
							<thead>
								<tr>
									<th>Fecha</th>
									<th>Mesa</th>
									<th>Concepto</th>
									<th>Monto</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Cierre de Caja -->
			<div id="close-cash" class="section">
				<div class="header">
					<h1>Cierre de Caja</h1>
					<div class="controls">
						<button class="btn btn-warning" onclick="generateCloseCash()">üìÑ Generar Cierre Actual</button>
						<button class="btn btn-secondary" onclick="viewClosureHistory()">üìã Historial</button>
					</div>
				</div>
				<div class="card">
					<div id="close-cash-content">
						<p class="text-center" style="color: var(--muted); padding: 40px;">
							Haz clic en "Generar Cierre Actual" para ver el resumen del d√≠a
						</p>
					</div>
				</div>

				<div id="closure-history" style="margin-top: 20px; display: none;">
					<h3 style="color: var(--accent); margin-bottom: 15px;">Historial de Cierres</h3>
					<div class="table-scroll">
						<table id="closures-table">
							<thead>
								<tr>
									<th>Fecha</th>
									<th>Transacciones</th>
									<th>Total</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Mesa -->
	<div id="table-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="table-modal-title">Nueva Mesa</h3>
				<button class="modal-close" onclick="closeTableModal()">‚úï</button>
			</div>
			<div class="form-row">
				<div class="form-group" style="flex: 1;">
					<label>N√∫mero de Mesa</label>
					<input type="number" id="table-number" placeholder="1">
				</div>
				<div class="form-group" style="flex: 1;">
					<label>Capacidad</label>
					<input type="number" id="table-capacity" placeholder="4">
				</div>
			</div>
			<div class="controls">
				<button class="btn" onclick="saveTable()">üíæ Guardar</button>
				<button class="btn btn-secondary" onclick="closeTableModal()">Cancelar</button>
			</div>
		</div>
	</div>

	<!-- Modal Producto Men√∫ -->
	<div id="menu-item-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="menu-item-modal-title">Nuevo Producto</h3>
				<button class="modal-close" onclick="closeMenuItemModal()">‚úï</button>
			</div>
			<div class="form-group">
				<label>Nombre</label>
				<input type="text" id="item-name" placeholder="Ej: Hamburguesa Cl√°sica">
			</div>
			<div class="form-group">
				<label>Descripci√≥n</label>
				<textarea id="item-description" placeholder="Descripci√≥n del producto"></textarea>
			</div>
			<div class="form-row">
				<div class="form-group" style="flex: 1;">
					<label>Categor√≠a</label>
					<input type="text" id="item-category" placeholder="Ej: Hamburguesas">
				</div>
				<div class="form-group" style="flex: 1;">
					<label>Precio</label>
					<input type="number" id="item-price" placeholder="0.00" step="0.01">
				</div>
			</div>
			<div class="form-group">
				<label>Imagen del Producto</label>
				<input type="file" id="item-image-file" accept="image/*" onchange="handleImageUpload(this)" style="width: 100%;">
				<small style="color: var(--muted); display: block; margin-top: 4px;">Sube una imagen desde tu dispositivo</small>
				<div id="item-image-preview" style="margin-top: 10px;"></div>
				<input type="hidden" id="item-image">
			</div>
			<div class="form-group">
				<label>
					<input type="checkbox" id="item-available" checked> Disponible
				</label>
			</div>
			<div class="controls">
				<button class="btn" onclick="saveMenuItem()">üíæ Guardar</button>
				<button class="btn btn-secondary" onclick="closeMenuItemModal()">Cancelar</button>
			</div>
		</div>
	</div>

	<!-- Modal Detalle de Mesa -->
	<div id="table-detail-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="table-detail-title">Detalle Mesa</h3>
				<button class="modal-close" onclick="closeTableDetailModal()">‚úï</button>
			</div>
			<div id="table-detail-content"></div>
		</div>
	</div>

	<script src="app.js"></script>
	<script>
		let currentEditingTable = null;
		let currentEditingMenuItem = null;
		let autoRefreshInterval = null;
		let isRefreshing = false;

		async function init() {
			await loadInitialData();
			await initializeDefaultData();
			renderDashboard();
			renderAllSections();
			startAutoRefresh();
		}
		
		// Auto-actualizaci√≥n cada 5 segundos
		function startAutoRefresh() {
			// Limpiar intervalo anterior si existe
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}
			
			// Actualizar cada 5 segundos
			autoRefreshInterval = setInterval(async () => {
				if (!isRefreshing) {
					isRefreshing = true;
					try {
						await loadInitialData();
						
						// Solo actualizar la secci√≥n activa para no interrumpir formularios
						const activeSection = document.querySelector('.section.active');
						if (activeSection) {
							const sectionId = activeSection.id;
							if (sectionId === 'dashboard') renderDashboard();
							if (sectionId === 'tables') renderTables();
							if (sectionId === 'orders') renderOrders();
							if (sectionId === 'transactions') renderTransactions();
						}
						
						// Actualizar badge de notificaciones si hay pedidos nuevos
						updateNotificationBadge();
					} catch (error) {
						console.error('Error en auto-refresh:', error);
					} finally {
						isRefreshing = false;
					}
				}
			}, 5000); // 5 segundos
		}
		
		function stopAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
				autoRefreshInterval = null;
			}
		}
		
		function updateNotificationBadge() {
			const activeOrders = AppState.orders.filter(o => o.status === 'pending').length;
			// Aqu√≠ podr√≠as agregar un badge visual si quieres
			if (activeOrders > 0) {
				document.title = `(${activeOrders}) Admin - Sistema Restaurante`;
			} else {
				document.title = 'Admin - Sistema Restaurante';
			}
		}

		function showSection(sectionId) {
			document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
			document.getElementById(sectionId).classList.add('active');
			document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
			event.target.closest('li').classList.add('active');
			
			// Pausar auto-refresh al editar men√∫ para no interrumpir
			if (sectionId === 'menu-config') {
				stopAutoRefresh();
			} else {
				startAutoRefresh();
			}
			
			if (sectionId === 'dashboard') renderDashboard();
			if (sectionId === 'tables') renderTables();
			if (sectionId === 'orders') renderOrders();
			if (sectionId === 'menu-config') renderMenuConfig();
			if (sectionId === 'transactions') renderTransactions();
		}

		async function refreshData() {
			const btn = event.target;
			btn.disabled = true;
			btn.textContent = '‚è≥ Actualizando...';
			
			await loadInitialData();
			renderAllSections();
			
			btn.disabled = false;
			btn.innerHTML = 'üîÑ Actualizar';
			
			// Mostrar notificaci√≥n temporal
			const notification = document.createElement('div');
			notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; animation: slideIn 0.3s ease;';
			notification.textContent = '‚úÖ Datos actualizados';
			document.body.appendChild(notification);
			
			setTimeout(() => {
				notification.style.animation = 'slideOut 0.3s ease';
				setTimeout(() => notification.remove(), 300);
			}, 2000);
		}

		function renderAllSections() {
			renderDashboard();
			renderTables();
			renderOrders();
			renderMenuConfig();
			renderTransactions();
		}

		// DASHBOARD
		function renderDashboard() {
			const occupiedTables = AppState.tables.filter(t => t.status === 'occupied').length;
			const activeOrders = AppState.orders.filter(o => o.status === 'pending').length;
			
			const today = new Date().toISOString().split('T')[0];
			const todaySales = AppState.transactions
				.filter(t => t.date && t.date.startsWith(today))
				.reduce((sum, t) => sum + (t.amount || 0), 0);
			
			const thisMonth = new Date().toISOString().slice(0, 7);
			const monthSales = AppState.transactions
				.filter(t => t.date && t.date.startsWith(thisMonth))
				.reduce((sum, t) => sum + (t.amount || 0), 0);

			document.getElementById('stat-tables').textContent = occupiedTables;
			document.getElementById('stat-orders').textContent = activeOrders;
			document.getElementById('stat-sales').textContent = Utils.formatCurrency(todaySales);
			document.getElementById('stat-month').textContent = Utils.formatCurrency(monthSales);

			const container = document.getElementById('dashboard-tables');
			container.innerHTML = AppState.tables.map(table => {
				const order = table.currentOrder ? AppState.orders.find(o => o.id === table.currentOrder) : null;
				return `
					<div class="table-card ${table.status}" onclick="viewTableDetails('${table.id}')">
						<div class="table-number">Mesa ${table.number}</div>
						<div class="table-status">
							${table.status === 'available' ? '‚úÖ Disponible' : 
							  table.status === 'occupied' ? 'üî¥ Ocupada' : 'üìù Reservada'}
						</div>
						${order ? `<div class="badge badge-warning" style="margin-top: 8px; font-size: 11px;">
							${order.items.length} productos | ${Utils.formatCurrency(order.total)}
						</div>` : ''}
					</div>
				`;
			}).join('');
		}

		// MESAS
		function renderTables() {
			const container = document.getElementById('tables-list');
			container.innerHTML = AppState.tables.map(table => {
				const order = table.currentOrder ? AppState.orders.find(o => o.id === table.currentOrder) : null;
				return `
					<div class="table-card ${table.status}">
						<div class="table-number">Mesa ${table.number}</div>
						<div class="table-status">Capacidad: ${table.capacity} personas</div>
						<div class="table-status">
							${table.status === 'available' ? '‚úÖ Disponible' : 
							  table.status === 'occupied' ? 'üî¥ Ocupada' : 'üìù Reservada'}
						</div>
						${order ? `<div class="badge badge-info" style="margin-top: 8px; font-size: 11px;">
							${order.items.length} productos | ${Utils.formatCurrency(order.total)}
						</div>` : ''}
						<div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
							${table.status === 'occupied' ? 
								`<button class="btn btn-small btn-warning" onclick="viewTableDetails('${table.id}')">üëÅÔ∏è Ver</button>` : ''}
							<button class="btn btn-small btn-secondary" onclick="editTable('${table.id}')">‚úèÔ∏è</button>
							<button class="btn btn-small btn-danger" onclick="deleteTable('${table.id}')">üóëÔ∏è</button>
							${table.status === 'occupied' ? 
								`<button class="btn btn-small btn-success" onclick="freeTable('${table.id}')">‚úì Liberar</button>` : ''}
						</div>
					</div>
				`;
			}).join('');
		}

		function openTableModal(tableId = null) {
			if (tableId) {
				currentEditingTable = AppState.tables.find(t => t.id === tableId);
				document.getElementById('table-modal-title').textContent = 'Editar Mesa';
				document.getElementById('table-number').value = currentEditingTable.number;
				document.getElementById('table-capacity').value = currentEditingTable.capacity;
			} else {
				currentEditingTable = null;
				document.getElementById('table-modal-title').textContent = 'Nueva Mesa';
				document.getElementById('table-number').value = '';
				document.getElementById('table-capacity').value = '4';
			}
			document.getElementById('table-modal').classList.add('show');
		}

		function closeTableModal() {
			document.getElementById('table-modal').classList.remove('show');
			currentEditingTable = null;
		}

		function editTable(tableId) {
			openTableModal(tableId);
		}

		async function saveTable() {
			const number = parseInt(document.getElementById('table-number').value);
			const capacity = parseInt(document.getElementById('table-capacity').value);

			if (!number || !capacity) {
				Utils.showNotification('Completa todos los campos', 'warning');
				return;
			}

			if (currentEditingTable) {
				currentEditingTable.number = number;
				currentEditingTable.capacity = capacity;
				const index = AppState.tables.findIndex(t => t.id === currentEditingTable.id);
				AppState.tables[index] = currentEditingTable;
			} else {
				AppState.tables.push({
					id: Utils.generateId(),
					number,
					capacity,
					status: 'available',
					currentOrder: null
				});
			}

			await API.save('tables', AppState.tables);
			closeTableModal();
			renderTables();
			renderDashboard();
			Utils.showNotification('Mesa guardada', 'success');
		}

		async function deleteTable(tableId) {
			if (!confirm('¬øEliminar esta mesa?')) return;
			AppState.tables = AppState.tables.filter(t => t.id !== tableId);
			await API.save('tables', AppState.tables);
			renderTables();
			renderDashboard();
			Utils.showNotification('Mesa eliminada', 'success');
		}

		async function freeTable(tableId) {
			if (!confirm('¬øLiberar esta mesa?')) return;
			const table = AppState.tables.find(t => t.id === tableId);
			if (table) {
				table.status = 'available';
				table.currentOrder = null;
				await API.save('tables', AppState.tables);
				renderTables();
				renderDashboard();
				Utils.showNotification('Mesa liberada', 'success');
			}
		}

		// PEDIDOS
		function renderOrders() {
			const container = document.getElementById('orders-list');
			const activeOrders = AppState.orders.filter(o => o.status === 'pending');
			
			if (activeOrders.length === 0) {
				container.innerHTML = '<p class="text-center" style="color: var(--muted); padding: 40px;">No hay pedidos activos</p>';
				return;
			}

			container.innerHTML = activeOrders.map(order => `
				<div class="order-card">
					<div class="order-header">
						<div>
							<strong style="color: var(--accent);">Mesa ${order.tableNumber}</strong>
							<div class="small">${Utils.formatDate(order.createdAt)}</div>
						</div>
						<div>
							<span class="badge badge-warning">Pendiente</span>
						</div>
					</div>
					<div class="order-items-list">
						${order.items.map(item => `
							<div class="order-item-line">
								<div>${item.quantity}x ${item.name} ${item.notes ? `<br><small style="color: var(--muted);">Nota: ${item.notes}</small>` : ''}</div>
								<div>${Utils.formatCurrency(item.price * item.quantity)}</div>
							</div>
						`).join('')}
					</div>
					<div style="text-align: right; font-size: 20px; font-weight: 700; color: var(--success); margin-top: 10px;">
						Total: ${Utils.formatCurrency(order.total)}
					</div>
					<div style="margin-top: 15px; display: flex; gap: 10px;">
						<button class="btn btn-success" onclick="completeOrder('${order.id}')">‚úì Completar y Facturar</button>
						<button class="btn btn-danger" onclick="cancelOrder('${order.id}')">‚úï Cancelar</button>
					</div>
				</div>
			`).join('');
		}

		async function completeOrder(orderId) {
			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) return;

			// Generar PDF antes de completar
			await generateInvoicePDF(order);

			// Marcar como completado
			order.status = 'completed';
			order.completedAt = new Date().toISOString();

			// Agregar transacci√≥n
			AppState.transactions.push({
				id: Utils.generateId(),
				orderId: order.id,
				tableNumber: order.tableNumber,
				amount: order.total,
				type: 'sale',
				date: new Date().toISOString(),
				concept: `Mesa ${order.tableNumber} - ${order.items.length} productos`
			});

			// Liberar mesa
			const table = AppState.tables.find(t => t.id === order.tableId);
			if (table) {
				table.status = 'available';
				table.currentOrder = null;
			}

			await API.save('orders', AppState.orders);
			await API.save('transactions', AppState.transactions);
			await API.save('tables', AppState.tables);

			renderOrders();
			renderDashboard();
			renderTransactions();
			Utils.showNotification('Pedido completado y facturado', 'success');
		}

		async function cancelOrder(orderId) {
			if (!confirm('¬øCancelar este pedido?')) return;
			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) return;

			order.status = 'cancelled';
			
			const table = AppState.tables.find(t => t.id === order.tableId);
			if (table) {
				table.status = 'available';
				table.currentOrder = null;
			}

			await API.save('orders', AppState.orders);
			await API.save('tables', AppState.tables);
			renderOrders();
			renderDashboard();
			Utils.showNotification('Pedido cancelado', 'success');
		}

		// MEN√ö CONFIG
		function renderMenuConfig() {
			const tbody = document.querySelector('#menu-table tbody');
			tbody.innerHTML = AppState.menuItems.map(item => `
				<tr>
					<td>
						<div style="display: flex; align-items: center; gap: 10px;">
							${item.image ? `<img src="${item.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">` : ''}
							<span>${item.name}</span>
						</div>
					</td>
					<td>${item.description || '-'}</td>
					<td><span class="badge badge-info">${item.category}</span></td>
					<td>${Utils.formatCurrency(item.price)}</td>
					<td><span class="badge ${item.available ? 'badge-success' : 'badge-danger'}">${item.available ? 'S√≠' : 'No'}</span></td>
					<td>
						<button class="btn btn-small btn-secondary" onclick="editMenuItem('${item.id}')">‚úèÔ∏è</button>
						<button class="btn btn-small btn-danger" onclick="deleteMenuItem('${item.id}')">üóëÔ∏è</button>
					</td>
				</tr>
			`).join('');
		}

		function openMenuItemModal(itemId = null) {
			if (itemId) {
				currentEditingMenuItem = AppState.menuItems.find(i => i.id === itemId);
				document.getElementById('menu-item-modal-title').textContent = 'Editar Producto';
				document.getElementById('item-name').value = currentEditingMenuItem.name;
				document.getElementById('item-description').value = currentEditingMenuItem.description || '';
				document.getElementById('item-category').value = currentEditingMenuItem.category;
				document.getElementById('item-price').value = currentEditingMenuItem.price;
				document.getElementById('item-available').checked = currentEditingMenuItem.available;
				document.getElementById('item-image').value = currentEditingMenuItem.image || '';
				if (currentEditingMenuItem.image) {
					showImagePreview(currentEditingMenuItem.image);
				} else {
					clearImagePreview();
				}
			} else {
				currentEditingMenuItem = null;
				document.getElementById('menu-item-modal-title').textContent = 'Nuevo Producto';
				document.getElementById('item-name').value = '';
				document.getElementById('item-description').value = '';
				document.getElementById('item-category').value = '';
				document.getElementById('item-price').value = '';
				document.getElementById('item-available').checked = true;
				document.getElementById('item-image').value = '';
				clearImagePreview();
			}
			document.getElementById('menu-item-modal').classList.add('show');
		}

		function closeMenuItemModal() {
			document.getElementById('menu-item-modal').classList.remove('show');
			currentEditingMenuItem = null;
		}

		function editMenuItem(itemId) {
			openMenuItemModal(itemId);
		}

		// Manejar carga de imagen
		function handleImageUpload(input) {
			if (input.files && input.files[0]) {
				const reader = new FileReader();
				reader.onload = function(e) {
					const imageData = e.target.result;
					document.getElementById('item-image').value = imageData;
					showImagePreview(imageData);
				};
				reader.readAsDataURL(input.files[0]);
			}
		}

		function showImagePreview(imageUrl) {
			if (!imageUrl) {
				document.getElementById('item-image-preview').innerHTML = '';
				return;
			}
			document.getElementById('item-image-preview').innerHTML = `
				<div style="position: relative; display: inline-block;">
					<img src="${imageUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid var(--accent);">
					<button onclick="clearImagePreview()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: #fff; border: 0; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">‚úï</button>
				</div>
			`;
		}

		function clearImagePreview() {
			document.getElementById('item-image').value = '';
			document.getElementById('item-image-file').value = '';
			document.getElementById('item-image-preview').innerHTML = '';
		}

		async function saveMenuItem() {
			const name = document.getElementById('item-name').value.trim();
			const description = document.getElementById('item-description').value.trim();
			const category = document.getElementById('item-category').value.trim();
			const price = parseFloat(document.getElementById('item-price').value);
			const available = document.getElementById('item-available').checked;
			const image = document.getElementById('item-image').value.trim();

			if (!name || !category || !price) {
				Utils.showNotification('Completa los campos requeridos', 'warning');
				return;
			}

			if (currentEditingMenuItem) {
				currentEditingMenuItem.name = name;
				currentEditingMenuItem.description = description;
				currentEditingMenuItem.category = category;
				currentEditingMenuItem.price = price;
				currentEditingMenuItem.available = available;
				currentEditingMenuItem.image = image;
				const index = AppState.menuItems.findIndex(i => i.id === currentEditingMenuItem.id);
				AppState.menuItems[index] = currentEditingMenuItem;
			} else {
				AppState.menuItems.push({
					id: Utils.generateId(),
					name,
					description,
					category,
					price,
					available,
					image
				});
			}

			await API.save('menu_items', AppState.menuItems);
			closeMenuItemModal();
			renderMenuConfig();
			Utils.showNotification('Producto guardado', 'success');
		}

		async function deleteMenuItem(itemId) {
			if (!confirm('¬øEliminar este producto?')) return;
			AppState.menuItems = AppState.menuItems.filter(i => i.id !== itemId);
			await API.save('menu_items', AppState.menuItems);
			renderMenuConfig();
			Utils.showNotification('Producto eliminado', 'success');
		}

		// TRANSACCIONES
		function renderTransactions() {
			const tbody = document.querySelector('#transactions-table tbody');
			const sorted = [...AppState.transactions].sort((a, b) => 
				new Date(b.date) - new Date(a.date)
			);
			
			if (sorted.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="color: var(--muted); padding: 40px;">No hay transacciones registradas</td></tr>';
				return;
			}

			tbody.innerHTML = sorted.map(t => `
				<tr>
					<td>${Utils.formatDate(t.date)}</td>
					<td>Mesa ${t.tableNumber || '-'}</td>
					<td>${t.concept}</td>
					<td style="color: var(--success); font-weight: 600;">${Utils.formatCurrency(t.amount)}</td>
					<td>
						<button class="btn btn-small btn-danger" onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button>
					</td>
				</tr>
			`).join('');
		}

		async function deleteTransaction(transactionId) {
			if (!confirm('¬øEliminar esta transacci√≥n?')) return;
			AppState.transactions = AppState.transactions.filter(t => t.id !== transactionId);
			await API.save('transactions', AppState.transactions);
			renderTransactions();
			renderDashboard();
			Utils.showNotification('Transacci√≥n eliminada', 'success');
		}

		// VER DETALLE DE MESA
		function viewTableDetails(tableId) {
			const table = AppState.tables.find(t => t.id === tableId);
			if (!table || !table.currentOrder) return;

			const order = AppState.orders.find(o => o.id === table.currentOrder);
			if (!order) return;

			document.getElementById('table-detail-title').textContent = `Mesa ${table.number} - Detalle`;
			
			const content = document.getElementById('table-detail-content');
			content.innerHTML = `
				<div style="margin-bottom: 20px;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
						<div>
							<strong style="color: var(--accent); font-size: 18px;">Mesa ${table.number}</strong>
							<div class="small" style="color: var(--muted);">${Utils.formatDate(order.createdAt)}</div>
						</div>
						<span class="badge badge-warning">Activo</span>
					</div>
					
					<div class="order-items-list" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h4 style="color: var(--accent); margin-bottom: 10px;">Productos</h4>
						${order.items.map(item => `
							<div class="order-item-line" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
								<div>
									<strong>${item.quantity}x ${item.name}</strong>
									${item.notes ? `<br><small style="color: var(--muted); font-size: 12px;">Nota: ${item.notes}</small>` : ''}
								</div>
								<div style="color: var(--success); font-weight: 600;">
									${Utils.formatCurrency(item.price * item.quantity)}
								</div>
							</div>
						`).join('')}
					</div>
					
					<div style="text-align: right; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border: 2px solid var(--success);">
						<div style="font-size: 14px; color: var(--muted); margin-bottom: 5px;">Total a Pagar</div>
						<div style="font-size: 28px; font-weight: 700; color: var(--success);">
							${Utils.formatCurrency(order.total)}
						</div>
					</div>
					
					<div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
						<button class="btn btn-warning" onclick="generateInvoicePDFFromModal('${order.id}')">üìÑ Generar PDF</button>
						<button class="btn btn-success" onclick="completeOrderFromModal('${order.id}')">‚úì Completar y Facturar</button>
						<button class="btn btn-secondary" onclick="closeTableDetailModal()">Cerrar</button>
					</div>
				</div>
			`;
			
			document.getElementById('table-detail-modal').classList.add('show');
		}

		function closeTableDetailModal() {
			document.getElementById('table-detail-modal').classList.remove('show');
		}

		async function generateInvoicePDFFromModal(orderId) {
			const order = AppState.orders.find(o => o.id === orderId);
			if (order) {
				await generateInvoicePDF(order);
				Utils.showNotification('PDF generado', 'success');
			}
		}

		async function completeOrderFromModal(orderId) {
			closeTableDetailModal();
			await completeOrder(orderId);
		}

		// CIERRE DE CAJA
		async function generateCloseCash() {
			const today = new Date().toISOString().split('T')[0];
			const todayTransactions = AppState.transactions.filter(t => t.date && t.date.startsWith(today));
			
			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			const totalOrders = todayTransactions.length;
			const completedOrders = AppState.orders.filter(o => 
				o.status === 'completed' && o.completedAt && o.completedAt.startsWith(today)
			).length;

			const container = document.getElementById('close-cash-content');
			container.innerHTML = `
				<div class="close-cash-summary">
					<h2>Cierre de Caja - ${new Date().toLocaleDateString('es-MX')}</h2>
					<div class="close-cash-line">
						<span>Total de Ventas:</span>
						<span>${totalOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Pedidos Completados:</span>
						<span>${completedOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Ingreso Bruto:</span>
						<span>${Utils.formatCurrency(totalSales)}</span>
					</div>
					<div class="close-cash-total">
						Total del D√≠a: ${Utils.formatCurrency(totalSales)}
					</div>
					<div style="margin-top: 20px; display: flex; gap: 10px;">
						<button class="btn" onclick="generateCloseCashPDF()">üìÑ Ver PDF</button>
						<button class="btn btn-success" onclick="saveCloseCash()">üíæ Guardar Cierre</button>
					</div>
				</div>
			`;

			document.getElementById('closure-history').style.display = 'none';
		}

		async function saveCloseCash() {
			const today = new Date().toISOString().split('T')[0];
			const todayTransactions = AppState.transactions.filter(t => t.date && t.date.startsWith(today));
			
			// Verificar si ya existe un cierre para hoy
			const existingClosure = AppState.cashClosures.find(c => c.date === today);
			if (existingClosure) {
				if (!confirm('Ya existe un cierre para hoy. ¬øDeseas actualizarlo?')) return;
			}

			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			const completedOrders = AppState.orders.filter(o => 
				o.status === 'completed' && o.completedAt && o.completedAt.startsWith(today)
			).length;

			const closure = {
				id: existingClosure ? existingClosure.id : Utils.generateId(),
				date: today,
				totalTransactions: todayTransactions.length,
				totalSales: totalSales,
				completedOrders: completedOrders,
				transactions: todayTransactions,
				createdAt: existingClosure ? existingClosure.createdAt : new Date().toISOString(),
				updatedAt: new Date().toISOString()
			};

			if (existingClosure) {
				const index = AppState.cashClosures.findIndex(c => c.id === closure.id);
				AppState.cashClosures[index] = closure;
			} else {
				AppState.cashClosures.push(closure);
			}

			await API.save('cash_closures', AppState.cashClosures);
			Utils.showNotification('Cierre de caja guardado correctamente', 'success');
		}

		function viewClosureHistory() {
			document.getElementById('close-cash-content').innerHTML = `
				<p class="text-center" style="color: var(--muted); padding: 40px;">
					Selecciona "Generar Cierre Actual" para ver el resumen del d√≠a o revisa el historial abajo
				</p>
			`;
			
			const historyDiv = document.getElementById('closure-history');
			historyDiv.style.display = 'block';
			
			const tbody = document.querySelector('#closures-table tbody');
			const sorted = [...AppState.cashClosures].sort((a, b) => 
				new Date(b.date) - new Date(a.date)
			);
			
			if (sorted.length === 0) {
				tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: var(--muted); padding: 40px;">No hay cierres guardados</td></tr>';
				return;
			}

			tbody.innerHTML = sorted.map(closure => `
				<tr>
					<td>${new Date(closure.date).toLocaleDateString('es-MX')}</td>
					<td>${closure.totalTransactions} ventas</td>
					<td style="color: var(--success); font-weight: 600;">${Utils.formatCurrency(closure.totalSales)}</td>
					<td>
						<button class="btn btn-small btn-warning" onclick="viewClosureDetail('${closure.id}')">üëÅÔ∏è Ver</button>
						<button class="btn btn-small btn-secondary" onclick="generateClosurePDF('${closure.id}')">üìÑ PDF</button>
						<button class="btn btn-small btn-danger" onclick="deleteClosure('${closure.id}')">üóëÔ∏è</button>
					</td>
				</tr>
			`).join('');
		}

		function viewClosureDetail(closureId) {
			const closure = AppState.cashClosures.find(c => c.id === closureId);
			if (!closure) return;

			const container = document.getElementById('close-cash-content');
			container.innerHTML = `
				<div class="close-cash-summary">
					<h2>Cierre de Caja - ${new Date(closure.date).toLocaleDateString('es-MX')}</h2>
					<div class="close-cash-line">
						<span>Total de Ventas:</span>
						<span>${closure.totalTransactions}</span>
					</div>
					<div class="close-cash-line">
						<span>Pedidos Completados:</span>
						<span>${closure.completedOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Ingreso Bruto:</span>
						<span>${Utils.formatCurrency(closure.totalSales)}</span>
					</div>
					<div class="close-cash-total">
						Total del D√≠a: ${Utils.formatCurrency(closure.totalSales)}
					</div>
					<div style="margin-top: 20px;">
						<button class="btn" onclick="generateClosurePDF('${closure.id}')">üìÑ Ver PDF</button>
					</div>
				</div>
			`;

			window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		function generateClosurePDF(closureId) {
			const closure = AppState.cashClosures.find(c => c.id === closureId);
			if (!closure) return;

			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			
			doc.setFontSize(20);
			doc.text('CIERRE DE CAJA', 105, 20, { align: 'center' });
			doc.setFontSize(12);
			doc.text(`Fecha: ${new Date(closure.date).toLocaleDateString('es-MX')}`, 105, 30, { align: 'center' });
			
			doc.setLineWidth(0.5);
			doc.line(20, 35, 190, 35);
			
			let y = 48;
			doc.setFontSize(14);
			doc.text('Resumen del D√≠a', 20, y);
			y += 10;
			
			doc.setFontSize(11);
			doc.text(`Total de Transacciones: ${closure.totalTransactions}`, 20, y);
			y += 8;
			doc.text(`Pedidos Completados: ${closure.completedOrders}`, 20, y);
			y += 8;
			doc.text(`Ingresos Totales: ${Utils.formatCurrency(closure.totalSales)}`, 20, y);
			y += 15;
			
			if (closure.transactions && closure.transactions.length > 0) {
				doc.setFontSize(14);
				doc.text('Detalle de Transacciones', 20, y);
				y += 8;
				
				doc.setFontSize(9);
				closure.transactions.forEach(t => {
					if (y > 270) {
						doc.addPage();
						y = 20;
					}
					doc.text(`${new Date(t.date).toLocaleTimeString('es-MX')} - Mesa ${t.tableNumber || '-'} - ${Utils.formatCurrency(t.amount)}`, 20, y);
					y += 6;
				});
			}
			
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		async function deleteClosure(closureId) {
			if (!confirm('¬øEliminar este cierre de caja?')) return;
			AppState.cashClosures = AppState.cashClosures.filter(c => c.id !== closureId);
			await API.save('cash_closures', AppState.cashClosures);
			viewClosureHistory();
			Utils.showNotification('Cierre eliminado', 'success');
		}

		// GENERAR PDF FACTURA
		async function generateInvoicePDF(order) {
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({
				unit: 'mm',
				format: [80, 200] // Formato ticket POS
			});

			doc.setFontSize(16);
			doc.text('RESTAURANTE', 40, 10, { align: 'center' });
			doc.setFontSize(10);
			doc.text('Ticket de Venta', 40, 16, { align: 'center' });
			doc.text('------------------------', 40, 20, { align: 'center' });
			
			doc.setFontSize(9);
			doc.text(`Mesa: ${order.tableNumber}`, 5, 26);
			doc.text(`Fecha: ${new Date(order.createdAt).toLocaleString('es-MX')}`, 5, 31);
			doc.text('------------------------', 40, 35, { align: 'center' });
			
			let y = 40;
			doc.setFontSize(8);
			order.items.forEach(item => {
				doc.text(`${item.quantity}x ${item.name}`, 5, y);
				doc.text(`$${(item.price * item.quantity).toFixed(2)}`, 70, y, { align: 'right' });
				y += 5;
				if (item.notes) {
					doc.setFontSize(7);
					doc.text(`  Nota: ${item.notes}`, 5, y);
					y += 4;
					doc.setFontSize(8);
				}
			});
			
			doc.text('------------------------', 40, y, { align: 'center' });
			y += 5;
			doc.setFontSize(12);
			doc.text(`TOTAL: $${order.total.toFixed(2)}`, 40, y, { align: 'center' });
			y += 7;
			doc.setFontSize(8);
			doc.text('Gracias por su preferencia', 40, y, { align: 'center' });
			
			// Abrir en nueva pesta√±a para visualizar
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		// GENERAR PDF CIERRE DE CAJA
		function generateCloseCashPDF() {
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			
			const today = new Date().toISOString().split('T')[0];
			const todayTransactions = AppState.transactions.filter(t => t.date && t.date.startsWith(today));
			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			
			doc.setFontSize(20);
			doc.text('CIERRE DE CAJA', 105, 20, { align: 'center' });
			doc.setFontSize(12);
			doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX')}`, 105, 30, { align: 'center' });
			doc.text(`Hora: ${new Date().toLocaleTimeString('es-MX')}`, 105, 37, { align: 'center' });
			
			doc.setLineWidth(0.5);
			doc.line(20, 42, 190, 42);
			
			let y = 55;
			doc.setFontSize(14);
			doc.text('Resumen del D√≠a', 20, y);
			y += 10;
			
			doc.setFontSize(11);
			doc.text(`Total de Transacciones: ${todayTransactions.length}`, 20, y);
			y += 8;
			doc.text(`Ingresos Totales: ${Utils.formatCurrency(totalSales)}`, 20, y);
			y += 15;
			
			doc.setFontSize(14);
			doc.text('Detalle de Transacciones', 20, y);
			y += 8;
			
			doc.setFontSize(9);
			todayTransactions.forEach(t => {
				if (y > 270) {
					doc.addPage();
					y = 20;
				}
				doc.text(`${new Date(t.date).toLocaleTimeString('es-MX')} - Mesa ${t.tableNumber || '-'} - ${Utils.formatCurrency(t.amount)}`, 20, y);
				y += 6;
			});
			
			// Abrir en nueva pesta√±a para visualizar
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		// Funciones para men√∫ m√≥vil
		function toggleMobileMenu() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.querySelector('.mobile-overlay');
			sidebar.classList.toggle('mobile-open');
			overlay.classList.toggle('active');
		}
		
		function closeMobileMenu() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.querySelector('.mobile-overlay');
			sidebar.classList.remove('mobile-open');
			overlay.classList.remove('active');
		}
		
		// Funci√≥n para cerrar sesi√≥n
		function logout() {
			if (confirm('¬øCerrar sesi√≥n?')) {
				localStorage.removeItem('userSession');
				window.location.href = '/login.html';
			}
		}

		init();
	</script>
</body>

</html>
